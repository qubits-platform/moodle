define("block_learnerscript/report",["block_learnerscript/select2","block_learnerscript/responsive.bootstrap","block_learnerscript/reportwidget","block_learnerscript/chart","block_learnerscript/smartfilter","block_learnerscript/helper","block_learnerscript/ajaxforms","block_learnerscript/ajax","jquery","block_learnerscript/radioslider","block_learnerscript/flatpickr","core/templates","jqueryui"],(function(select2,DataTable,reportwidget,chart,smartfilter,helper,AjaxForms,ajax,$,RadiosToSlider,flatpickr,templates){var report,BasicparamCourse=$(".basicparamsform #id_filter_courses"),BasicparamUser=$(".basicparamsform #id_filter_users"),BasicparamActivity=$(".basicparamsform #id_filter_activities"),FilterCourse=$(".filterform #id_filter_courses"),FilterUser=$(".filterform #id_filter_users"),FilterActivity=$(".filterform #id_filter_activities"),FilterModule=$(".filterform #id_filter_modules"),FilterCohort=$(".filterform #id_filter_cohort"),NumberOfBasicParams=0;return report={init:function(args){if($.ui.dialog.prototype._focusTabbable=$.noop,$.fn.dataTable.ext.errMode="none",$(".plotgraphcontainer").on("click",(function(){var reportid=$(this).data("reportid");$(".plotgraphcontainer").removeClass("show").addClass("hide"),$("#plotreportcontainer"+reportid).html("")})),$("select[data-select2='1']").select2({theme:"classic"}).on("select2:selecting",(function(e){$(this).val()&&$(this).data("maximumSelectionLength")&&$(this).val().length>=$(this).data("maximumSelectionLength")&&(e.preventDefault(),$(this).select2("close"))})),$("#reportsearch").val(args.reportid).trigger("change.select2"),$("#reportsearch").change((function(){var reportid=$(this).find(":selected").val();window.location=M.cfg.wwwroot+"/blocks/learnerscript/viewreport.php?id="+reportid})),RadiosToSlider.init($("#segmented-button"),{size:"medium",animation:!0,reportdashboard:!1}),flatpickr("#customrange",{mode:"range",onOpen:function(selectedDates,dateStr,instance){instance.clear()},onClose:function(selectedDates,dateStr,instance){0!==selectedDates.length&&($("#ls_fstartdate").val(selectedDates[0].getTime()/1e3),$("#ls_fenddate").val(selectedDates[1].getTime()/1e3+86400),require(["block_learnerscript/report"],(function(report){report.CreateReportPage({reportid:args.reportid,instanceid:args.reportid,reportdashboard:!1})})))}}),$("#id_filter_cohort").change((function(){var cohortid=$(this).find(":selected").val();cohortid>0&&(FilterUser.length>0||BasicparamUser.length>0)&&(BasicparamUser.length>0&&(FirstElementActive=!0),smartfilter.CohortUsers({cohortid:cohortid,reporttype:args.reporttype,reportid:args.reportid,firstelementactive:FirstElementActive}))})),void 0===BasicparamCourse&&void 0===FilterCourse||$("#id_filter_courses").change((function(){args.courseid=$(this).find(":selected").val(),smartfilter.CourseData(args)})),$("#id_filter_users").change((function(){$(this).find(":selected").val()>0&&(FilterCourse.length>0||BasicparamCourse.length>0)&&BasicparamCourse.length>0&&(FirstElementActive=!0)})),$("#id_filter_coursecategories").change((function(){var categoryid=$(this).find(":selected").val();smartfilter.categoryCourses({categoryid:categoryid,reporttype:args.reporttype})})),schedule.SelectRoleUsers(),null!=args.basicparams&&"courses"==args.basicparams[0].name&&($("#id_filter_courses").trigger("change"),NumberOfBasicParams++),null!=args.basicparams){var FirstElementActive=!1;if("users"==args.basicparams[0].name)BasicparamCourse.length>0&&(FirstElementActive=!0),$("#id_filter_users").find(":selected").val()>0&&(args.courseid=$("#id_filter_courses").find(":selected").val(),smartfilter.CourseData(args))}$(".filterform"+args.reportid+" .fitemtitle").hide(),$(".filterform"+args.reportid+" .felement").attr("style","margin:0"),$(".basicparamsform"+args.reportid+" .fitemtitle").hide(),$(".basicparamsform"+args.reportid+" .felement").attr("style","margin:0"),$(".filterform #id_filter_clear").click((function(e){$(".filterform"+args.reportid).trigger("reset");$(this).parent().find("#id_filter_activities");FilterUser.length>0&&(FilterCourse.length>0||BasicparamCourse.length>0)&&BasicparamCourse.length>0&&(FirstElementActive=!0),FilterCourse.length>0&&(FilterUser.length>0||BasicparamUser.length,(FilterActivity.length>0||BasicparamActivity.length>0)&&smartfilter.CourseActivities({courseid:0})),(FilterActivity.length>0||FilterModule.length>0)&&((FilterCourse.length>0||BasicparamCourse.length>0)&&0==BasicparamUser.length&&BasicparamCourse.length>0&&0==BasicparamUser.length&&(FirstElementActive=!0),BasicparamCourse.length>0&&BasicparamUser.length>0&&$(".basicparamsform #id_filter_apply").trigger("click",[!0])),FilterCohort.length>0&&FilterUser.length>0&&smartfilter.CohortUsers({cohortid:0}),$(".basicparamsform #id_filter_apply").length>0?($(document).ajaxComplete((function(event,xhr,settings){})),$(".basicparamsform #id_filter_apply").trigger("click",[!0])):(args.reporttype=$(".ls-plotgraphs_listitem.ui-tabs-active").data("cid"),report.CreateReportPage({reportid:args.reportid,reporttype:args.reporttype,instanceid:args.reportid})),$(".filterform select[data-select2='1']").select2("destroy").select2({theme:"classic"}),$(".filterform select[data-select2-ajax='1']").val("0").trigger("change"),$(".filterform")[0].reset(),$(".filterform #id_filter_clear").attr("disabled","disabled"),$(".plotgraphcontainer").removeClass("show").addClass("hide"),$("#plotreportcontainer"+args.instanceid).html("")})),$(".basicparamsform #id_filter_apply,.filterform #id_filter_apply").click((function(e,validate){var getreport=helper.validatebasicform(validate);e.preventDefault(),e.stopImmediatePropagation(),$(".filterform"+args.reportid).show(),args.instanceid=args.reportid,"Get Report"!=e.currentTarget.value&&$(".filterform #id_filter_clear").removeAttr("disabled"),-1!=$.inArray(0,getreport)?($("#report_plottabs").hide(),$("#reportcontainer"+args.reportid).html("<div class='alert alert-info'>No data available</div>")):($("#report_plottabs").show(),args.reporttype=$(".ls-plotgraphs_listitem.ui-tabs-active").data("cid"),report.CreateReportPage({reportid:args.reportid,reporttype:args.reporttype,instanceid:args.instanceid,reportdashboard:!1})),$(".plotgraphcontainer").removeClass("show").addClass("hide"),$("#plotreportcontainer"+args.instanceid).html("")})),null==args.basicparams?report.CreateReportPage({reportid:args.reportid,reporttype:args.reporttype,instanceid:args.reportid,reportdashboard:!1}):args.basicparams.length<=4?$(".basicparamsform #id_filter_apply").trigger("click",[!0]):$(document).ajaxComplete((function(event,xhr,settings){if(settings.url.indexOf("blocks/learnerscript/ajax.php")>0){if(void 0!==settings.data){var ajaxaction=$.parseJSON(settings.data);void 0!==ajaxaction.basicparam&&1==ajaxaction.basicparam&&NumberOfBasicParams++}args.basicparams.length==NumberOfBasicParams&&"plotforms"!=ajaxaction.action&&"pluginlicence"!=ajaxaction.action&&$(".basicparamsform #id_filter_apply").trigger("click",[!0])}}))},CreateReportPage:function(args){var disabletable=0;0==args.reportdashboard&&((disabletable=$("#disabletable").val())&&(args.reporttype=$($(".ls-plotgraphs_listitem")[0]).data("cid")));1==disabletable&&args.reporttype.length>0?chart.HighchartsAjax({reportid:args.reportid,action:"generate_plotgraph",cols:args.cols,reporttype:args.reporttype}):0==disabletable&&reportwidget.CreateDashboardwidget({reportid:args.reportid,reporttype:"table",instanceid:args.instanceid,reportdashboard:args.reportdashboard})},generate_plotgraph:function(response){switch(response.containerid="plotreportcontainer"+response.reportinstance,response.type){case"pie":chart.piechart(response);break;case"spline":case"bar":case"column":chart.lbchart(response);break;case"solidgauge":chart.solidgauge(response);break;case"combination":chart.combinationchart(response);break;case"map":chart.WorldMap(response);break;case"treemap":chart.TreeMap(response)}},ReportDatatable:function(args){var params={},reportinstance=args.instanceid?args.instanceid:args.reportid;if(params.filters=args.filters,params.basicparams=args.basicparams||JSON.stringify(smartfilter.BasicparamsData(reportinstance)),params.reportid=args.reportid,params.columns=args.columns,$.fn.dataTable.pipeline=function(opts){var conf=$.extend({url:"",data:null,method:"POST"},opts);return function(request,drawCallback,settings){var requestStart=request.start,requestLength=(request.start,request.length);void 0!==args.data&&1==request.draw?(json=args.data,json.draw=request.draw,json.data.splice(0,requestStart),json.data.splice(requestLength,json.data.length),drawCallback(json)):(request.start=requestStart,request.length=requestLength,$.extend(request,conf.data),settings.jqXHR=$.ajax({type:conf.method,url:conf.url,data:request,dataType:"json",cache:!1,success:function(json){drawCallback(json)}}))}},"Users profile"==args.reportname||"Course profile"==args.reportname)var lengthoptions=[[50,100,-1],["Show 50","Show 100","Show All"]];else lengthoptions=[[10,25,50,100,-1],["Show 10","Show 25","Show 50","Show 100","Show All"]];$("#reporttable_"+reportinstance).DataTable({processing:!0,serverSide:!0,destroy:!0,dom:'<"co_report_header"Bf <"report_header_skew"  <"report_header_skew_content" Bl<"report_header_showhide" ><"report_calculation_showhide" >> > > tr <"co_report_footer"ip>',ajax:$.fn.dataTable.pipeline({type:"POST",url:M.cfg.wwwroot+"/blocks/learnerscript/components/datatable/server_processing.php?sesskey="+M.cfg.sesskey,data:params}),columnDefs:args.columnDefs,fnDrawCallback:function(oSettings,json){chart.SparkLineReport(),helper.DrilldownReport()},oScroll:{},responsive:!0,fnInitComplete:function(){this.fnAdjustColumnSizing(!0),"Users profile"!=args.reportname&&"Course profile"!=args.reportname||($("#reporttable_"+reportinstance+"_wrapper .co_report_header").remove(),$("#reporttable_"+reportinstance+"_wrapper .co_report_footer").remove()),$(".download_menu"+reportinstance+" li a").each((function(index){var link=$(this).attr("href");if(void 0!==args.basicparams){var basicparamsdata=JSON.parse(args.basicparams);$.each(basicparamsdata,(function(key,value){0==key.indexOf("filter_")&&(link+="&"+key+"="+value)}))}if(void 0!==args.filters){var filters=JSON.parse(args.filters);$.each(filters,(function(key,value){0==key.indexOf("filter_")&&(link+="&"+key+"="+value),0==key.indexOf("ls_")&&(link+="&"+key+"="+value)}))}$(this).attr("href",link)}))},fnRowCallback:function(nRow,aData,iDisplayIndex){return $(nRow).children().each((function(index,td){$(td).css("word-break",args.columnDefs[index].wrap),$(td).css("width",args.columnDefs[index].width)})),nRow},autoWidth:!1,aaSorting:[],language:{paginate:{previous:"<",next:">"},sProcessing:"<img src='"+M.util.image_url("loading","block_learnerscript")+"'>",search:"_INPUT_",searchPlaceholder:"Search",lengthMenu:"_MENU_",emptyTable:"<div class='alert alert-info'>No data available</div>"},lengthMenu:lengthoptions});$(".drilldown"+reportinstance+" .ui-dialog-title").html(args.reportname),$("#page-blocks-learnerscript-viewreport #reporttable_"+args.reportid+"_wrapper div.report_header_showhide").html($("#export_options"+args.reportid).html()),$(".reportcalculation"+args.reportid).length>0&&$("#page-blocks-learnerscript-viewreport #reporttable_"+args.reportid+"_wrapper div.report_calculation_showhide").html('<img src="'+M.util.image_url("calculationicon","block_learnerscript")+"\" onclick=\"(function(e){ require('block_learnerscript/helper').reportCalculations({reportid:"+args.reportid+'}) })(event)" title ="Calculations" />')},AddExpressions:function(e,value){$(e.target).on("select2:unselecting",(function(e){$("#fitem_id_"+e.params.args.data.id).remove()}));var columns=$(e.target).val();$.each(columns,(function(index){if(!($("#fitem_id_"+columns[index]).length>0)){var column=[];column.name=columns[index],column.conditionsymbols=[];$.each(["=",">","<",">=","<=","<>"],(function(index,value){column.conditionsymbols.push({value:value})}));var requestdata={column:column};templates.render("block_learnerscript/plotconditions",requestdata).then((function(html){"yaxisbarvalue"==value?$("#yaxis_bar1").append(html):$("#yaxis1").append(html)})).fail((function(ex){}))}}))},block_statistics_help:function(reportid){ajax.call({args:{action:"learnerscriptdata",reportid:reportid},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done((function(response){require(["core/modal_factory"],(function(ModalFactory){ModalFactory.create({title:response.name,body:response.summary,footer:""}).done((function(modal){dialogue=modal,ModalEvents=require("core/modal_events"),dialogue.getRoot().on(ModalEvents.hidden,(function(){})),dialogue.show()}))}))}))}}}));

//# sourceMappingURL=report.min.js.map